### Restaurant

ASP.NET Core Web API-приложение, конвертирующее каталог в REST API.

Общий формат вызова:

```
https://host:port/api?op=operation&params
```

здесь `port` - номер порта, `operation` - код операции, `params` - параметры операции (зависят от конкретной операции).

Допустимые операции:

* **db_info** - получение информации о базе данных.
  * Возвращает объект, в котором имеют смысл только поля `name`, `maxMfn`, `logicallyDeleted`, `nonActualizedRecords`, `lockedRecords`.
  * Параметр **db** - имя базы данных
  * Пример запроса: `https://localhost:5001/api?op=db_info&db=IBIS`, ответ:
  ```json
  {
    "name": "IBIS",
    "description": null,
    "maxMfn": 2454799,
    "logicallyDeleted": [1302, 1303, 2438207],
    "nonActualizedRecords": [],
    "lockedRecords": [],
    "databaseLocked": false,
    "readOnly": false
  }
  ```

  * **list_db** - получение списка баз данных.
    * Возвращает массив объектов, в которых имеют смысл только поля `name` и `description`.
    * Опциональный параметр **spec** - спецификация файла со списком баз
    * Пример запроса: `https://localhost:5001/api?op=list_db&spec=dbnam2.mnu`, ответ:
    ```json
    [
      {
        "name": "ISTU",
        "description": "Монографии и учебники",
        "maxMfn": 0,
        "logicallyDeleted": null,
        "physicallyDeleted": null,
        "nonActualizedRecords": null,
        "lockedRecords": null,
        "databaseLocked": false,
        "readOnly": false
      },
      {
        "name": "PERIO",
        "description": "Периодические издания",
        "maxMfn": 0,
        "logicallyDeleted": null,
        "physicallyDeleted": null,
        "nonActualizedRecords": null,
        "lockedRecords": null,
        "databaseLocked": false,
        "readOnly": false
      }
    ]
    ```

* **list_files** - получение списка файлов.
  * Возвращает массив строк - имен файлов
  * Параметр **spec** - спецификация файлов
  * Пример запроса: `https://localhost:5001/api?op=list_files&spec=2.ISTU.*.fst`, ответ:
  ```json
  [
    "BUS1.FST",
    "BUS1W.FST",
    "BUS2.FST",
    "BUSU.FST",
    "IBISZ.FST",
    "VS600.fst"
  ]
  ```

* **list_proc** - список серверных процессов.
  * Возвращает массив объектов
  * Параметров нет
  * Пример ответа:
  ```json
  [
    {
      "number": "*",
      "ipAddress": "Local IP address",
      "name": "Сервер ИРБИС",
      "clientId": "*****",
      "workstation": "*****",
      "started": "31.08.2021 12:54:50",
      "lastCommand": "*****",
      "commandNumber": "*****",
      "processId": "6744",
      "state": "Активный"
    },
    {
      "number": "1",
      "ipAddress": "Disconnected",
      "name": "",
      "clientId": "179310",
      "workstation": "",
      "started": "31.08.2021 13:03:29",
      "lastCommand": "IRBIS_CONTEXT_LIST",
      "commandNumber": "2",
      "processId": "1076",
      "state": "Пассивный"
    }
  ]
  ```

* **list_terms** - получение списка поисковых терминов, начинающихся с указанного префикса.
  * Возвращает массив строк - терминов словаря (префикс удален)
  * Параметры: **db** - имя базы данных, **prefix** - префикс.
  * Пример запроса: `https://localhost:5001/api?op=list_terms&db=IBIS&prefix=J=`, ответ:
  ```json
    [
       "ARM",
       "AZE",
       "ENG",
       "ESP",
       "GER",
       "NNN",
       "ZXX"
       ]
  ```

* **max_mfn** - получение максимального MFN для указанной базы данных.
  * Возвращает целое число - максимальный MFN
  * Параметр: **db** - имя базы данных
  * Пример запроса: `https://localhost:5001/api?op=max_mfn&db=IBIS`, ответ:
  ```json
  2454799
  ```

* **read** - чтение библиографической записи.
  * Возвращает JSON-представление записи
  * Параметр: **db** - имя базы данных, **mfn** - MFN требуемой записи
  * Пример запроса: `https://localhost:5001/api?op=read&db=IBIS&mfn=123`, ответ:
  ```json
  {
  }
  ```

* **read_menu** - чтение файла меню
  * Возвращает структуру, содержащую массив пар "код-комментарий"
  * Параметр: **spec** - спецификация файла
  * Пример запроса: `https://localhost:5001/api?op=read_menu&spec=2.ISTU.488m.mnu`, ответ:
  ```json
  {
   "entries": [
    {
     "code": "Является приложением к книге",
     "comment": ""
    },
    {
     "code": "Есть приложение на CD-ROM",
     "comment": ""
    },
    {
     "code": "Архивная ссылка",
     "comment": ""
    },
    {
     "code": "Из альбома",
     "comment": ""
    },
    {
     "code": "Из коллекции",
     "comment": ""
    },
    {
     "code": "В комплекте с ",
     "comment": ""
    },
    {
     "code": "В одной коллекции с",
     "comment": ""
    },
    {
      "code": "Вариант ",
      "comment": "В другом материале или копия"
    },
    {
      "code": "Продолж. серии ",
      "comment": "Продолжение серии изделий"
    }
   ]
  }
  ```

* **read_opt** - чтение OPT-файла
  * Возвращает сложную структуру, включающую массив пар "код-рабочий лист"
  * Параметр: **spec** - спецификация файла
  * Пример запроса: `https://localhost:5001/api?op=read_opt&spec=2.ISTU.pftw.opt`, ответ:
  ```json
  {
    "lines": [
      {
        "key": "J",
        "value": "JW"
      },
      {
        "key": "NJ",
        "value": "NJW"
      },
      {
        "key": "NJP",
        "value": "NJW"
      },
      {
        "key": "NJK",
        "value": "NJW"
      },
      {
        "key": "SPEC",
        "value": "MN"
      },
      {
        "key": "ASP",
        "value": "ASP"
      },
      {
        "key": "MUSP",
        "value": "MUSI"
      },
      {
        "key": "AUNTD",
        "value": "ASP"
      },
      {
        "key": "BOUNI",
        "value": "VS600"
      },
      {
        "key": "+++++",
        "value": "KN"
      }
    ],
    "worksheetLength": 5,
    "worksheetTag": 920
  }
  ```

* **read_terms** - чтение поисковых терминов
  * Возвращает массив терминов словаря
  * Параметры: **db** - имя базы данных, **start** - стартовый термин, **count** - требуемое количество терминов
  * Пример запроса: `https://localhost:5001/api?op=read_terms&db=IBIS&start=K=%D0%91%D0%95%D0%A2%D0%9E%D0%9D&count=10`, ответ:
  ```json
  [
    {
      "count": 406,
      "text": "K=БЕТОН"
    },
    {
      "count": 1,
      "text": "K=БЕТОН В СТАЛЬНОЙ ТРУБЕ"
    },
    {
      "count": 1,
      "text": "K=БЕТОН И ЖЕЛЕЗОБЕТОН"
    },
    {
      "count": 1,
      "text": "K=БЕТОН СВЕРХВЫСОКОЙ МОРОЗОСТОЙКОСТИ"
    },
    {
      "count": 1,
      "text": "K=БЕТОН ЯЧЕИСТЫЙ"
    },
    {
      "count": 646,
      "text": "K=БЕТОНА"
    },
    {
      "count": 5,
      "text": "K=БЕТОНАМ"
    },
    {
      "count": 3,
      "text": "K=БЕТОНАМИ"
    },
    {
      "count": 8,
      "text": "K=БЕТОНАХ"
    }
  ]
  ```

* **read_text** - чтение текстового файла с сервера
  * Возвращает содержимое файла в виде одной строки (возможно, содержащей символы перевода строки)
  * Параметр: **spec** - спецификация файла
  * Пример запроса: `https://localhost:5001/api?op=read_text&spec=2.IBIS.marci.gbl`, ответ:
  ```
  0
  DEL
  1000
  *


  DEL
  998
  *


  DEL
  461
  F
  if 'ASP NJ':v920 then'1'else'0'fi

  DEL
  463^!
  *


  ```

* **restart** - перезапуск сервера ИРБИС64
  * Не принимает параметров
  * Ничего не возвращает
  * Пример вызова: `https://localhost:5001/api?op=restart`

* **scenarios** - получение списка сценариев поиска по базе данных
  * Не реализовано

* **search** - поиск записей по словарю.
  * Возвращает массив MFN найденных записей (возможно, пустой)
  * Параметры: **db** - имя базы данных, **expr** - выражение на поисковом языке ИРБИС64
  * Пример запроса: `https://localhost:5001/api?op=search&db=IBIS&expr=A=%D0%9F%D0%A3%D0%A8%D0%9A%D0%98%D0%9D$`, ответ:
  ```json
  [
    3404,
    3405,
    3406,
    3407,
    3408,
    3409,
    3410,
    3427
  ]
  ```

* **search_count** - получение числа записей, соответствующих поисковому запросу.
  * Возвращает целое число - количество найденных записей (возможно, 0)
  * Параметры: **db** - имя базы данных, **expr** - выражение на поисковом языке ИРБИС64
  * Пример запроса: `https://localhost:5001/api?op=search_count&db=IBIS&expr=A=%D0%9F%D0%A3%D0%A8%D0%9A%D0%98%D0%9D$`, ответ:
  ```json
  3858
  ```

* **search_format** - поиск записей с последующим расформатированием.
  * Возвращает массив строк - результат расформатирования найденных записей
  * Параметры: **db** - имя базы данных, **expr** - выражение на поисковом языке ИРБИС64, **format** - спецификация формата
  * Пример запроса: `https://localhost:5001/api?op=search_format&db=IBIS&expr=A=%D0%9F%D0%A3%D0%A8%D0%9A%D0%98%D0%9D$&format=@brief`, ответ:
  ```json
  [
    "Пушкин, Александр Сергеевич. Письма к жене : письма / А. С. Пушкин ; сост. Я. Л. Левкович, 1986. - 260 с.",
    "Пушкин, Александр Сергеевич. Стихи, написанные в Михайловском. / А. С. Пушкин, 1980. - 272 с.",
    "Мейлах, Борис Соломонович. Декабристы и Пушкин : страницы героико-трагической истории / Б. С. Мейлах, 1987. - 367 с.",
    "Пушкин и Франция / Сост. В.Т. Данченко, 1999. - 199 с.",
    "Касаткина, Вера Николаевна. Романтическая муза Пушкина / В. Н. Касаткина, 2001. - 128 с.",
    "Кашицын, Александр Александрович. И божество, и вдохновенье... : Женский идеал в жизни и творчестве Пушкина / А.А. Кашицын, 1999. - 60 с.",
    "Иркутский историко-экономический ежегодник. 2002 / М-во образования РФ. ИГЭА. Регион. центр науч. исслед. эконом. истории России, 2002. - 167 с. (Введено оглавление)",
    "Юрьева, Ольга Юрьевна. Русская литература XIX века : Жуковский. Грибоедов. Пушкин. Лермонтов : Учеб. пособие / О. Ю. Юрьева; М-во общ. и проф. образовани РФ. ИГПУ. Гл. упр. общ. и    проф. образования администрации Иркут. обл., 2002. - 253,[2] с.",
    "Миниатюpная Пушкиниана из редкого фонда Поэтической библиотеки В.Сеpбского : Каталог выставки, 2000. - 63 с.",
    "Пушкина, Т. Л. Русское старожильческое население Верхоленского округа Иркутской губернии во второй половине XIX - нач. XX вв.: к истории изучения вопроса / Т. Л. Пушкина // Третьи    Романовские чтения : Материалы науч. конф., посвящ. 130-летию со дня рождения Н. С. Романова и 340-летию основания Иркут. острога окт. 2001 г. / ИГУ. Науч. б-ка. - Иркутск : Изд-во   ИГУ, 2001. - С. 77 - 81",
    "Сергеев, Марк Давидович. Итак, я счастлив был... : книга о Пушкине / Марк Сергеев, 1999. - 416 с.",
    "Романовские чтения, третьи : материалы науч. конф., посвящ. 130-летию со дня рождения Н. С. Романова и 340-летию основания Иркут. острога [г. Иркутск, окт. 2001 г.] / Иркут. гос.     ун-т, Науч. б-ка , 2001. - 198 с. (Введено оглавление)",
    "Я к вам пишу... : Пушкиниана на откpытках XIX-XX вв / сост., авт. предисл., авт. послесл.: М. Д. Филин, М. С. Забоченя, 1999. - 208 с.",
    "Дубров, Александр Петрович. Парапсихология и современное естествознание / А.П. Дубров, В.Н. Пушкин , 1990. - 279 с.",
    "Кондакова, Надежда Васильевна. Пушкинский календарь / Н.В. Кондакова, В.В. Чепкунов, 1999. - 391 с.",
    "Проскуpин, Олег Анатольевич. Поэзия Пушкина, или Подвижный палимпсест / О.А. Пpоскуpин, 1999. - 462 с.",
    "Кошелев, Вячеслав Анатольевич. Пушкин: история и пpедание : Очеpки / В.А. Кошелев, 2000. - 359 с.",
    "Александpов, Hиколай Дмитpиевич. Силуэты пушкинской эпохи / Н.Д. Александpов, 1999. - 320 с.",
    "Дуэль Пушкина с Дантесом-Геккереном: Подлинное военно-судное дело 1837 г. : сборник документов : издано в пользу фонда Пушкинского Лицейского Общества / предисловие к репринтному     изданию и очерки Д. А. Алексеева, 1994. - [2], IV, 160, [10], 30 с.",
    "Родина : стихи рус. поэтов : [для старшего возраста / рис. Т. Прибыловской, 1986. - 271 с."
  ]
  ```

* **server_stat** - статистика работы сервера ИРБИС64.
  * Возвращает сложную структуру, включающую в себя массив объектов - активных клиентов
  * Не принимает параметров
  * Пример запроса: `https://localhost:5001/api?op=server_stat`, ответ:
  ```json
  {
    "clients": [
    {
      "number": "*",
      "ipAddress": "127.0.0.1",
      "port": "6666",
      "name": "Сервер ИРБИС",
      "id": "*****",
      "workstation": "*****",
      "registered": "31.08.2021 12:54:50",
      "acknowledged": "*****",
      "lastCommand": "*****",
      "commandNumber": "*****"
    },
    {
      "number": "1",
      "ipAddress": "127.0.0.1",
      "port": "6666",
      "name": "librarian",
      "id": "314713",
      "workstation": ""Каталогизатор"",
      "registered": "31.08.2021 13:50:31",
      "acknowledged": "31.08.2021 13:50:31",
      "lastCommand": "IRBIS_REG",
      "commandNumber": "1"
      }
    ],
    "clientCount": 2,
    "totalCommandCount": 50
  }
  ```

* **user_list** - получение списка пользователей ИРБИС64
  * Возвращает массив объектов
  * Параметр:
  * Пример запроса: `https://localhost:5001/api?op=list_users`, ответ:
  ```json
  [
    {
      "name": "librarian",
      "password": "secret",
      "cataloguer": "irbisc.ini",
      "reader": "irbisr.ini",
      "circulation": "irbisb.ini",
      "acquisitions": "irbisp.ini",
      "provision": "irbisk.ini",
      "administrator": "irbisa.ini"
    },
    {
      "name": "user",
      "password": "password",
      "cataloguer": "irbisc.ini",
      "reader": "irbisr.ini",
      "circulation": "irbisb.ini",
      "acquisitions": null,
      "provision": null,
      "administrator": null
    }
  ]
  ```

* **version** - получение версии сервера ИРБИС64
  * Возвращает структуру, содержащую информацию о версии, количестве достуных лицензий и числе активных клиентов
  * Не принимает параметров
  * Пример запроса: ``, ответ:
  ```json
  {
    "organization": "Иркутский государственный технический университет",
    "version": "64.2014",
    "maxClients": 100000,
    "connectedClients": 1
  }
  ```

#### Пример сообщения об ошибке

```json
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.6.1",
  "title": "An error occurred while processing your request.",
  "status": 500,
  "detail": "Can't connect to IRBIS64",
  "traceId": "00-c3a6fe26848fbb40ba6cc6492e258096-251beea813a74c4b-00"
}
```
